{% extends "base.html" %}

{% block title %}{{ get_room_name(room) }} - {{ get_translation('schedule', 'Schedule') }} - {{ get_translation('app_title') }}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="row justify-content-center">
        <div class="col-12 col-lg-10">
            <!-- Header -->
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 class="text-primary">
                    <i class="fas fa-calendar-alt me-2"></i>
                    {{ get_room_name(room) }} - {{ get_translation('schedule', 'Schedule') }}
                </h2>
                <div class="d-flex flex-column flex-md-row gap-2">
                    <a href="{{ url_for('book_room', room_id=room.id) }}" class="btn btn-success">
                        <i class="fas fa-plus me-2"></i>
                        {{ get_translation('book_room', 'Book Room') }}
                    </a>
                    <a href="{{ url_for('index') }}" class="btn btn-outline-primary">
                        <i class="fas fa-home me-2"></i>
                        {{ get_translation('back_to_rooms', 'Back to Rooms') }}
                    </a>
                </div>
            </div>

            <!-- Room Info Card -->
            <div class="card mb-4 bg-white">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <h5 class="mb-1 text-dark">{{ get_room_name(room) }}</h5>
                            <p class="text-muted mb-0">
                                <i class="fas fa-map-marker-alt me-1"></i>
                                {{ get_room_location(room) }}
                            </p>
                        </div>
                        <div class="col-md-4 text-md-end">
                            <span class="badge bg-info fs-6">
                                <i class="fas fa-users me-1"></i>
                                {{ room.capacity }} {{ get_translation('people', 'people') }}
                            </span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Date Selection -->
            <div class="card mb-4 bg-white">
                <div class="card-body">
                    <div class="row align-items-end">
                        <div class="col-12 col-md-8 mb-3 mb-md-0">
                            <label for="schedule-date" class="form-label text-dark">
                                <i class="fas fa-calendar me-1"></i>
                                {{ get_translation('select_date', 'Select Date') }}
                            </label>
                            <input type="date" 
                                   id="schedule-date" 
                                   class="form-control" 
                                   value="{{ selected_date }}"
                                   min="{{ selected_date }}">
                        </div>
                        <div class="col-12 col-md-4">
                            <button id="refresh-schedule" class="btn btn-outline-primary w-100">
                                <i class="fas fa-sync-alt me-2"></i>
                                {{ get_translation('refresh', 'Refresh') }}
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bookings List -->
            <div class="card bg-white">
                <div class="card-header bg-white border-0">
                    <h5 class="mb-0 text-dark">
                        <i class="fas fa-list me-2"></i>
                        {{ get_translation('bookings_for_date', 'Bookings for Date') }}
                    </h5>
                </div>
                <div class="card-body">
                    <div id="bookings-list">
                        <!-- Bookings will be loaded here -->
                        <div class="text-center text-muted py-4">
                            <i class="fas fa-spinner fa-spin fa-2x mb-3"></i>
                            <p>{{ get_translation('loading', 'Loading...') }}</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const roomId = {{ room.id }};
    const dateInput = document.getElementById('schedule-date');
    const refreshButton = document.getElementById('refresh-schedule');
    const bookingsListDiv = document.getElementById('bookings-list');
    const companies = {{ companies|tojson }};

    // Load bookings when date changes
    dateInput.addEventListener('change', function() {
        loadSchedule();
    });

    // Refresh button
    refreshButton.addEventListener('click', function() {
        loadSchedule();
    });

    // Load initial schedule
    loadSchedule();

    // Auto-refresh every 30 seconds
    setInterval(loadSchedule, 30000);

    function loadSchedule() {
        const selectedDate = dateInput.value;
        refreshButton.innerHTML = '<i class="fas fa-spin fa-spinner me-2"></i>{{ get_translation("loading", "Loading...") }}';
        refreshButton.disabled = true;

        fetch(`/api/schedule/${roomId}?date=${selectedDate}`)
            .then(response => response.json())
            .then(data => {
                displayBookings(data.bookings, selectedDate);
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
                bookingsListDiv.innerHTML = `
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        {{ get_translation('error_loading', 'Error loading data') }}
                    </div>
                `;
            })
            .finally(() => {
                refreshButton.innerHTML = '<i class="fas fa-sync-alt me-2"></i>{{ get_translation("refresh", "Refresh") }}';
                refreshButton.disabled = false;
            });
    }

    function displayBookings(bookings, selectedDate) {
        const selectedDateObj = new Date(selectedDate);
        const today = new Date();
        const formattedDate = selectedDateObj.toLocaleDateString('{{ lang }}', { 
            weekday: 'long', 
            year: 'numeric', 
            month: 'long', 
            day: 'numeric' 
        });

        if (bookings.length === 0) {
            bookingsListDiv.innerHTML = `
                <div class="text-center text-muted py-4">
                    <i class="fas fa-calendar-check fa-2x mb-3"></i>
                    <h6 class="text-muted mb-2">${formattedDate}</h6>
                    <p>{{ get_translation('no_bookings') }}</p>
                </div>
            `;
            return;
        }

        let html = `
            <div class="mb-3">
                <h6 class="text-primary mb-3">
                    <i class="fas fa-calendar me-1"></i>
                    ${formattedDate}
                </h6>
            </div>
            <div class="list-group list-group-flush">
        `;

        // Sort bookings by start time
        bookings.sort((a, b) => a.start_time.localeCompare(b.start_time));

        bookings.forEach(booking => {
            const companyName = companies[booking.user_company] || booking.user_company;
            const adminLevel = {{ admin_level }};

            html += `
                <div class="list-group-item border-0 px-0 py-3 bg-white">
                    <div class="booking-info">
                        <div class="booking-time-badge">
                            <span class="badge bg-primary rounded-pill px-3 py-2 text-white">
                                ${booking.start_time}â€“${booking.end_time}
                            </span>
                        </div>
                        <div class="booking-details">
                            <h6 class="mb-1 text-dark">
                                <i class="fas fa-user me-1 text-muted"></i>
                                ${booking.user_name}
                            </h6>
                            <p class="mb-1 text-secondary">
                                <i class="fas fa-building me-1 text-muted"></i>
                                ${companyName}
                            </p>
                            ${booking.purpose ? `
                                <p class="mb-1 text-muted">
                                    <i class="fas fa-clipboard me-1"></i>
                                    ${booking.purpose}
                                </p>
                            ` : ''}
                            ${booking.admin_comment ? `
                                <div class="admin-comment">
                                    <i class="fas fa-comment admin-comment-icon me-1"></i>
                                    <strong>{{ get_translation('admin_comment', 'Admin comment') }}:</strong>
                                    ${booking.admin_comment}
                                </div>
                            ` : ''}
                        </div>
                        ${adminLevel > 0 ? `
                            <div class="booking-actions">
                                <div class="btn-group btn-group-sm" role="group">
                                    <a href="/edit-booking/${booking.id}" class="btn btn-outline-primary btn-sm">
                                        <i class="fas fa-edit me-1"></i>
                                        {{ get_translation('edit', 'Edit') }}
                                    </a>
                                    <button type="button" 
                                            class="btn btn-outline-danger btn-sm"
                                            onclick="showDeleteModal(${booking.id}, ${booking.telegram_id}, '${booking.user_name}', '${booking.date}', '${booking.start_time}-${booking.end_time}')">
                                        <i class="fas fa-trash me-1"></i>
                                        {{ get_translation('delete', 'Delete') }}
                                    </button>
                                </div>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        });

        html += '</div>';
        bookingsListDiv.innerHTML = html;
    }

    // Delete confirmation modal functions
    window.showDeleteModal = function(bookingId, bookingUserId, userName, date, time) {
        const currentUserId = {{ telegram_id }};
        const adminLevel = {{ admin_level }};

        if (bookingUserId == currentUserId || adminLevel == 0) {
            // User deleting their own booking or non-admin
            if (confirm('{{ get_translation('confirm_delete', 'Are you sure?') }}')) {
                deleteBooking(bookingId);
            }
        } else {
            // Admin deleting someone else's booking
            const modal = document.getElementById('deleteModal');
            document.getElementById('deleteBookingId').value = bookingId;
            document.getElementById('deleteUserName').textContent = userName;
            document.getElementById('deleteDateTime').textContent = `${date} ${time}`;
            document.getElementById('adminReason').value = '';
            modal.style.display = 'block';
        }
    };

    window.deleteBooking = function(bookingId, reason = '') {
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = `/delete-booking/${bookingId}`;

        if (reason) {
            const reasonInput = document.createElement('input');
            reasonInput.type = 'hidden';
            reasonInput.name = 'admin_reason';
            reasonInput.value = reason;
            form.appendChild(reasonInput);
        }

        document.body.appendChild(form);
        form.submit();
    };

    window.confirmDelete = function() {
        const bookingId = document.getElementById('deleteBookingId').value;
        const reason = document.getElementById('adminReason').value.trim();

        if (!reason) {
            alert('{{ get_translation('reason_required', 'Reason is required') }}');
            return;
        }

        deleteBooking(bookingId, reason);
    };

    window.closeDeleteModal = function() {
        document.getElementById('deleteModal').style.display = 'none';
    };
});
</script>

<!-- Delete Confirmation Modal -->
<div id="deleteModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-exclamation-triangle text-warning me-2"></i>
                    {{ get_translation('confirm_delete', 'Confirm Delete') }}
                </h5>
            </div>
            <div class="modal-body">
                <p><strong>{{ get_translation('deleting_booking_for', 'Deleting booking for') }}:</strong></p>
                <p><i class="fas fa-user me-1"></i> <span id="deleteUserName"></span></p>
                <p><i class="fas fa-calendar me-1"></i> <span id="deleteDateTime"></span></p>

                <div class="mb-3">
                    <label for="adminReason" class="form-label">
                        <i class="fas fa-pen me-1"></i>
                        {{ get_translation('reason_for_deletion', 'Reason for deletion') }} *
                    </label>
                    <textarea class="form-control" id="adminReason" rows="3" 
                              placeholder="{{ get_translation('enter_reason', 'Enter reason for deletion...') }}" required></textarea>
                    <small class="form-text text-muted">{{ get_translation('reason_will_be_sent', 'This reason will be sent to the user') }}</small>
                </div>

                <input type="hidden" id="deleteBookingId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" onclick="closeDeleteModal()">
                    <i class="fas fa-times me-2"></i>
                    {{ get_translation('cancel', 'Cancel') }}
                </button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">
                    <i class="fas fa-trash me-2"></i>
                    {{ get_translation('delete', 'Delete') }}
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}